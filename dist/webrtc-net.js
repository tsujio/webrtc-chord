/**
* @license almond 0.2.9 Copyright (c) 2011-2014, The Dojo Foundation All Rights Reserved.
* Available via the MIT or new BSD license.
* see: http://github.com/jrburke/almond for details
*/

(function(e,t){typeof define=="function"&&define.amd?define([],t):e.Chord=t()})(this,function(){var e,t,n;return function(r){function v(e,t){return h.call(e,t)}function m(e,t){var n,r,i,s,o,u,a,f,c,h,p,v=t&&t.split("/"),m=l.map,g=m&&m["*"]||{};if(e&&e.charAt(0)===".")if(t){v=v.slice(0,v.length-1),e=e.split("/"),o=e.length-1,l.nodeIdCompat&&d.test(e[o])&&(e[o]=e[o].replace(d,"")),e=v.concat(e);for(c=0;c<e.length;c+=1){p=e[c];if(p===".")e.splice(c,1),c-=1;else if(p===".."){if(c===1&&(e[2]===".."||e[0]===".."))break;c>0&&(e.splice(c-1,2),c-=2)}}e=e.join("/")}else e.indexOf("./")===0&&(e=e.substring(2));if((v||g)&&m){n=e.split("/");for(c=n.length;c>0;c-=1){r=n.slice(0,c).join("/");if(v)for(h=v.length;h>0;h-=1){i=m[v.slice(0,h).join("/")];if(i){i=i[r];if(i){s=i,u=c;break}}}if(s)break;!a&&g&&g[r]&&(a=g[r],f=c)}!s&&a&&(s=a,u=f),s&&(n.splice(0,u,s),e=n.join("/"))}return e}function g(e,t){return function(){return s.apply(r,p.call(arguments,0).concat([e,t]))}}function y(e){return function(t){return m(t,e)}}function b(e){return function(t){a[e]=t}}function w(e){if(v(f,e)){var t=f[e];delete f[e],c[e]=!0,i.apply(r,t)}if(!v(a,e)&&!v(c,e))throw new Error("No "+e);return a[e]}function E(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function S(e){return function(){return l&&l.config&&l.config[e]||{}}}var i,s,o,u,a={},f={},l={},c={},h=Object.prototype.hasOwnProperty,p=[].slice,d=/\.js$/;o=function(e,t){var n,r=E(e),i=r[0];return e=r[1],i&&(i=m(i,t),n=w(i)),i?n&&n.normalize?e=n.normalize(e,y(t)):e=m(e,t):(e=m(e,t),r=E(e),i=r[0],e=r[1],i&&(n=w(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:n}},u={require:function(e){return g(e)},exports:function(e){var t=a[e];return typeof t!="undefined"?t:a[e]={}},module:function(e){return{id:e,uri:"",exports:a[e],config:S(e)}}},i=function(e,t,n,i){var s,l,h,p,d,m=[],y=typeof n,E;i=i||e;if(y==="undefined"||y==="function"){t=!t.length&&n.length?["require","exports","module"]:t;for(d=0;d<t.length;d+=1){p=o(t[d],i),l=p.f;if(l==="require")m[d]=u.require(e);else if(l==="exports")m[d]=u.exports(e),E=!0;else if(l==="module")s=m[d]=u.module(e);else if(v(a,l)||v(f,l)||v(c,l))m[d]=w(l);else{if(!p.p)throw new Error(e+" missing "+l);p.p.load(p.n,g(i,!0),b(l),{}),m[d]=a[l]}}h=n?n.apply(a[e],m):undefined;if(e)if(s&&s.exports!==r&&s.exports!==a[e])a[e]=s.exports;else if(h!==r||!E)a[e]=h}else e&&(a[e]=n)},e=t=s=function(e,t,n,a,f){if(typeof e=="string")return u[e]?u[e](t):w(o(e,t).f);if(!e.splice){l=e,l.deps&&s(l.deps,l.callback);if(!t)return;t.splice?(e=t,t=n,n=null):e=r}return t=t||function(){},typeof n=="function"&&(n=a,a=f),a?i(r,e,t,n):setTimeout(function(){i(r,e,t,n)},4),s},s.config=function(e){return s(e)},e._defined=a,n=function(e,t,n){t.splice||(n=t,t=[]),!v(a,e)&&!v(f,e)&&(f[e]=[e,t,n])},n.amd={jQuery:!0}}(),n("lib/almond",function(){}),n("underscore",[],function(){return _}),n("cryptojs",[],function(){return CryptoJS}),n("Utils",["underscore"],function(e){var t={isNonemptyString:function(t){return e.isString(t)&&!e.isEmpty(t)},isValidNumber:function(t){return!e.isNaN(t)&&e.isNumber(t)},isPositiveNumber:function(e){return t.isValidNumber(e)&&e>0},isZeroOrPositiveNumber:function(e){return e===0||t.isPositiveNumber(e)},insert:function(e,t,n){e.splice(t,0,n)},enableDebugLog:function(e){t.debug=function(){if(e){var t=Array.prototype.slice.call(arguments),n=new Date,r=[n.getHours(),n.getMinutes(),n.getSeconds()].join(":")+":";t.unshift(r),console.log.apply(console,t)}}},debug:function(){}},n=function(t,n){var r=this;this._items=[],this._comparator=n,e.each(t,function(e){r.put(e)})};n.prototype={put:function(e){(this.size()===0||!this.has(e))&&this._items.push(e)},remove:function(t){var n=this;this._items=e.reject(this._items,function(e){return n._comparator(e,t)})},size:function(){return e.size(this._items)},has:function(t){var n=this;return e.some(this._items,function(e){return n._comparator(e,t)})},items:function(){return this._items}},t.Set=n;var r=function(){this._items=[]};r.prototype={enqueue:function(e){this._items.push(e)},dequeue:function(){return e.isEmpty(this._items)?null:this._items.shift()},first:function(){return e.isEmpty(this._items)?null:e.first(this._items)},last:function(){return e.isEmpty(this._items)?null:e.last(this._items)},size:function(){return e.size(this._items)}},t.Queue=r;var i=function(e,t){this._cache={},this._useHistory=[],this._capacity=e,this._cacheOutCallback=t};return i.prototype={get:function(t){return e.has(this._cache,t)?(this._updateUseHistory(t),this._cache[t]):null},set:function(t,n){var r=this;this._cache[t]=n,this._updateUseHistory(t);if(e.size(this._cache)>this._capacity){var i=e.rest(this._useHistory,this._capacity);this._useHistory=e.first(this._useHistory,this._capacity),e.each(i,function(e){var t=r._cache[e];delete r._cache[e],r._cacheOutCallback(t)})}},remove:function(t){if(!this.has(t))return;this._useHistory=e.reject(this._useHistory,function(e){return e===t}),delete this._cache[t]},has:function(t){return e.has(this._cache,t)},keys:function(){return e.keys(this._cache)},_updateUseHistory:function(t){this._useHistory=e.reject(this._useHistory,function(e){return e===t}),this._useHistory.unshift(t)}},t.Cache=i,t}),n("ID",["underscore","cryptojs","Utils"],function(e,t,n){var r=function(t){e.each(t,function(t){if(e.isNaN(t)||!e.isNumber(t)||t<0||255<t)throw new Error("Invalid argument.")});if(e.size(t)!==r._BYTE_SIZE)throw new Error("Invalid argument.");this._bytes=e.last(t,r._BYTE_SIZE)};return r._BYTE_SIZE=32,r.create=function(e){if(!n.isNonemptyString(e))throw new Error("Invalid argument.");return new r(r._createBytes(e))},r._createBytes=function(e){var n=t.SHA256(e).toString(t.enc.Hex);return r._createBytesfromHexString(n)},r._createBytesfromHexString=function(t){if(!n.isNonemptyString(t))throw new Error("Invalid argument.");return e(Math.floor(e.size(t)/2)).times(function(e){return parseInt(t.substr(e*2,2),16)})},r.fromHexString=function(e){return new r(r._createBytesfromHexString(e))},r.prototype={isInInterval:function(t,n){if(e.isNull(t)||e.isNull(n))throw new Error("Invalid arguments.");if(t.equals(n))return!this.equals(t);if(t.compareTo(n)<0)return this.compareTo(t)>0&&this.compareTo(n)<0;var i=new r(e(e.size(this._bytes)).times(function(){return 0})),s=new r(e(e.size(this._bytes)).times(function(){return 255}));return!t.equals(s)&&this.compareTo(t)>0&&this.compareTo(s)<=0||!i.equals(n)&&this.compareTo(i)>=0&&this.compareTo(n)<0},addPowerOfTwo:function(t){if(!e.isNumber(t))throw new Error("Invalid argument.");if(t<0||t>=this.getLength())throw new Error("Power of two out of index.");var n=e.clone(this._bytes),i=e.size(this._bytes)-1-Math.floor(t/8),s=[1,2,4,8,16,32,64,128][t%8];for(var o=i;o>=0;o--){n[o]+=s,s=n[o]>>8,n[o]&=255;if(s===0)break}return new r(n)},compareTo:function(t){if(this.getLength()!==t.getLength())throw new Error("Invalid argument.");var n=e.zip(this._bytes,t._bytes);for(var r=0;r<n.length;r++){if(n[r][0]<n[r][1])return-1;if(n[r][0]>n[r][1])return 1}return 0},equals:function(e){return this.compareTo(e)===0},getLength:function(){return e.size(this._bytes)*8},toHexString:function(){return e.map(this._bytes,function(e){var t=e.toString(16);return e<16?"0"+t:t}).join("")}},r}),n("Response",["underscore","Utils"],function(e,t){var n=function(n,r,i,s,o){if(!t.isNonemptyString(n)||!t.isNonemptyString(r)||!e.isObject(i)||!t.isNonemptyString(s)||!e.isNumber(o))throw new Error("Invalid argument.");this.status=n,this.method=r,this.result=i,this.requestId=s,this.timestamp=o};return n.create=function(t,r,i){return new n(t,i.method,r,i.requestId,e.now())},n.isResponse=function(n){return e.isObject(n)?t.isNonemptyString(n.status)?!0:!1:!1},n.fromJson=function(t){if(!e.isObject(t))throw new Error("Invalid argument.");return new n(t.status,t.method,t.result,t.requestId,t.timestamp)},n.prototype={toJson:function(){return{status:this.status,method:this.method,result:this.result,requestId:this.requestId,timestamp:this.timestamp}}},n}),n("Request",["underscore","cryptojs","Response","Utils"],function(e,t,n,r){var i=function(t,n,i,s){if(!r.isNonemptyString(t)||!e.isObject(n)||!r.isNonemptyString(i)||!e.isNumber(s))throw new Error("Invalid argument.");this.method=t,this.params=n,this.requestId=i,this.timestamp=s};return i.create=function(t,n){return new i(t,n,i._createId(),e.now())},i._createId=function(){return t.SHA256(Math.random().toString()).toString()},i.isRequest=function(e){return!n.isResponse(e)},i.fromJson=function(t){if(!e.isObject(t))throw new Error("Invalid argument.");return new i(t.method,t.params,t.requestId,t.timestamp)},i.prototype={toJson:function(){return{method:this.method,params:this.params,requestId:this.requestId,timestamp:this.timestamp}}},i}),n("Entry",["underscore","ID"],function(e,t){var n=function(t,n){if(e.isNull(t)||e.isUndefined(n))throw new Error("Invalid argument.");this.id=t,this.value=n};return n.fromJson=function(r){if(!e.isObject(r))throw new Error("invalid argument.");return new n(t.fromHexString(r.id),r.value)},n.prototype={equals:function(t){return t instanceof n?this.id.equals(t.id)&&e.isEqual(this.value,t.value):!1},toJson:function(){return{id:this.id.toHexString(),value:this.value}}},n}),n("Node",["underscore","ID","Request","Entry","Utils"],function(e,t,n,r,i){var s=function(e,n,r,o,u){if(!s.isValidNodeInfo(e))throw new Error("Invalid arguments.");i.isZeroOrPositiveNumber(u.requestTimeout)||(u.requestTimeout=18e4),this._peerId=e.peerId,this.nodeId=t.create(e.peerId),this._nodeFactory=n,this._connectionFactory=r,this._requestHandler=o,this._config=u};return s.isValidNodeInfo=function(t){return e.isObject(t)?i.isNonemptyString(t.peerId)?!0:!1:!1},s.prototype={findSuccessor:function(e,n){var r=this;if(!(e instanceof t)){n(null);return}this._sendRequest("FIND_SUCCESSOR",{key:e.toHexString()},{success:function(e){var t=e.successorNodeInfo;r._nodeFactory.create(t,n)},error:function(e){n(null,e)}})},notifyAndCopyEntries:function(t,n){var i=this;this._sendRequest("NOTIFY_AND_COPY",{potentialPredecessorNodeInfo:t.toNodeInfo()},{success:function(t){if(!e.isArray(t.referencesNodeInfo)||!e.isArray(t.entries)){n(null,null);return}i._nodeFactory.createAll(t.referencesNodeInfo,function(i){var s=e.chain(t.entries).map(function(e){try{return r.fromJson(e)}catch(t){return null}}).reject(function(t){return e.isNull(t)}).value();n(i,s)})},error:function(e){n(null,null,e)}})},notify:function(t,n){var r=this;this._sendRequest("NOTIFY",{potentialPredecessorNodeInfo:t.toNodeInfo()},{success:function(t){if(!e.isArray(t.referencesNodeInfo)){n(null);return}r._nodeFactory.createAll(t.referencesNodeInfo,function(e){n(e)})},error:function(e){n(null,e)}})},leavesNetwork:function(t){var n=this;if(e.isNull(t))throw new Error("Invalid argument.");this._sendRequest("LEAVES_NETWORK",{predecessorNodeInfo:t.toNodeInfo()})},ping:function(e){this._sendRequest("PING",{},{success:function(t){e(!0)},error:function(t){e(!1,t)}})},insertReplicas:function(t){this._sendRequest("INSERT_REPLICAS",{replicas:e.invoke(t,"toJson")})},removeReplicas:function(t,n){this._sendRequest("REMOVE_REPLICAS",{sendingNodeId:t.toHexString(),replicas:e.invoke(n,"toJson")})},insertEntry:function(e,t){this._sendRequest("INSERT_ENTRY",{entry:e.toJson()},{success:function(e){t()},error:function(e){t(e)}})},retrieveEntries:function(t,n){var i=this;this._sendRequest("RETRIEVE_ENTRIES",{id:t.toHexString()},{success:function(t){if(!e.isArray(t.entries)){n(null,new Error("Received invalid data from "+i._peerId));return}var s=e.chain(t.entries).map(function(e){try{return r.fromJson(e)}catch(t){return null}}).reject(function(t){return e.isNull(t)}).value();n(s)},error:function(e){n(null,e)}})},removeEntry:function(e,t){this._sendRequest("REMOVE_ENTRY",{entry:e.toJson()},{success:function(e){t()},error:function(e){t(e)}})},sendMessage:function(e){this._sendRequest("UPPER_LAYER_MESSAGE",{message:e})},_sendRequest:function(t,r,s){var o=this;this._connectionFactory.create(this._peerId,function(u,a){if(a){e.isUndefined(s)||s.error(a);return}var f=n.create(t,r);if(!e.isUndefined(s)){var l=setTimeout(function(){var n=o._nodeFactory.deregisterCallback(f.requestId);e.isNull(n)||s.error(new Error(t+" request to "+o._peerId+" timed out."))},o._config.requestTimeout);o._nodeFactory.registerCallback(f.requestId,e.once(function(e){clearTimeout(l);if(e.status!=="SUCCESS"){var t=new Error("Request to "+o._peerId+" failed: "+e.result.message);s.error(t);return}s.success(e.result)}))}i.debug("Sending request to",o._peerId,":",f.method);try{u.send(f)}finally{u.close()}})},onRequestReceived:function(e){var t=this;i.debug("Received request from",this._peerId,":",e.method),this._requestHandler.handle(this._peerId,e,function(e){t._connectionFactory.create(t._peerId,function(n,r){if(r){console.log(r);return}i.debug("Sending response to",t._peerId,":",e.method);try{n.send(e)}finally{n.close()}})})},onResponseReceived:function(t){i.debug("Received response from",this._peerId,":",t.method,"(",t.status,")");var n=this._nodeFactory.deregisterCallback(t.requestId);e.isNull(n)||n(t)},disconnect:function(){this._connectionFactory.removeConnection(this._peerId)},getPeerId:function(){return this._peerId},toNodeInfo:function(){return{nodeId:this.nodeId.toHexString(),peerId:this._peerId}},equals:function(t){return e.isNull(t)?!1:this.nodeId.equals(t.nodeId)},toString:function(){return this.nodeId.toHexString()+" ("+this._peerId+")"}},s}),n("peerjs",[],function(){return Peer}),n("PeerAgent",["underscore","peerjs","Utils"],function(e,t,n){var r=function(r,i){var s=this;e.isObject(r.peer)||(r.peer={id:undefined,options:{}}),e.isObject(r.peer.options)||(r.peer.options={}),n.isZeroOrPositiveNumber(r.connectRateLimit)||(r.connectRateLimit=3e3),n.isZeroOrPositiveNumber(r.connectionOpenTimeout)||(r.connectionOpenTimeout=3e4),e.isString(r.peer.id)?this._peer=new t(r.peer.id,r.peer.options):this._peer=new t(r.peer.options),this._config=r,this._callbacks=i,this._waitingTimer=null,this.connect=e.throttle(this.connect,r.connectRateLimit);var o=e.once(i.onPeerSetup);this._peer.on("open",function(e){n.debug("Peer opend (peer ID:",e,")"),s._peer.on("connection",function(e){n.debug("Connection from",e.peer),i.onConnection(e.peer,e)}),s._peer.on("close",function(){n.debug("Peer closed."),i.onPeerClosed()}),o(e)}),this._peer.on("error",function(e){n.debug("Peer error:",e);var t=e.message.match(/Could not connect to peer (\w+)/);if(t){if(!s.isWaitingOpeningConnection())return;clearTimeout(s._waitingTimer),s._waitingTimer=null;var r=t[1];i.onConnectionOpened(r,null,e);return}console.log(e),o(null,e)})};return r.prototype={connect:function(e){var t=this,r=this._peer.connect(e);if(!r){var i=new Error("Failed to open connection to "+e+".");this._callbacks.onConnectionOpened(e,null,i);return}this._waitingTimer=setTimeout(function(){if(!t.isWaitingOpeningConnection())return;t._waitingTimer=null;var n=new Error("Opening connection to "+e+" timed out.");t._callbacks.onConnectionOpened(e,null,n)},this._config.connectionOpenTimeout),r.on("open",function(){n.debug("Connection to",r.peer,"opened.");if(!t.isWaitingOpeningConnection()){r.close();return}clearTimeout(t._waitingTimer),t._waitingTimer=null,t._callbacks.onConnectionOpened(e,r)})},isWaitingOpeningConnection:function(){return!e.isNull(this._waitingTimer)},destroy:function(){this._peer.destroy()},getPeerId:function(){return this._peer.id},listAllPeers:function(e){this._peer.listAllPeers(e)}},r}),n("Connection",["underscore","Request","Response"],function(e,t,n){var r=function(e,t){var n=this;this._conn=e,this._callbacks=t,this._conn.on("data",function(e){n._onDataReceived(e)}),this._conn.on("close",function(){t.closedByRemote(n)}),this._conn.on("error",function(e){console.log(e)})};return r.prototype={send:function(e,t){this._conn.send(e.toJson())},_onDataReceived:function(e){var r=this;if(n.isResponse(e)){var i;try{i=n.fromJson(e)}catch(s){return}this._callbacks.responseReceived(this,i)}else if(t.isRequest(e)){var o;try{o=t.fromJson(e)}catch(s){return}this._callbacks.requestReceived(this,o)}},close:function(){this._callbacks.closedByLocal(this)},destroy:function(){this._conn.close()},getPeerId:function(){return this._conn.peer},isAvailable:function(){return this._conn.open}},r}),n("ConnectionFactory",["underscore","PeerAgent","Connection","Utils"],function(e,t,n,r){var i=function(i,s,o){var u=this,a=function(e,t){e.close(),s.onRequestReceived(e.getPeerId(),t)},f=function(e,t){e.close(),s.onResponseReceived(e.getPeerId(),t)},l=function(e){u.removeConnection(e.getPeerId())},c=function(e){u._connectionPool.set(e.getPeerId(),e)};this._peerAgent=new t(i,{onPeerSetup:function(e,t){if(t){o(null,t);return}o(u)},onConnectionOpened:function(e,t,r){if(r){u._invokeNextCallback(e,null,r);return}var i=new n(t,{requestReceived:a,responseReceived:f,closedByRemote:l,closedByLocal:c});u._invokeNextCallback(e,i)},onConnection:function(t,r){u._connectionPool.has(t)&&u.removeConnection(t);var s,o=setTimeout(function(){s.close()},i.silentConnectionCloseTimeout),h=e.once(function(){clearTimeout(o)});s=new n(r,{requestReceived:function(e,t){h(),a(e,t)},responseReceived:function(e,t){h(),f(e,t)},closedByRemote:l,closedByLocal:c})},onPeerClosed:function(){e.each(u._connectionPool.keys(),function(e){u.removeConnection(e)})}}),r.isZeroOrPositiveNumber(i.connectionPoolSize)||(i.connectionPoolSize=10),r.isZeroOrPositiveNumber(i.connectionCloseDelay)||(i.connectionCloseDelay=5e3),r.isZeroOrPositiveNumber(i.silentConnectionCloseTimeout)||(i.silentConnectionCloseTimeout=3e4),this._connectionPool=new r.Cache(i.connectionPoolSize,function(t){e.delay(function(){t.destroy()},i.connectionCloseDelay)}),this._callbackQueue=new r.Queue};return i.create=function(e,t,n){var r=new i(e,t,n)},i.prototype={create:function(e,t){var n=this;if(!r.isNonemptyString(e)){t(null);return}this._callbackQueue.enqueue({peerId:e,callback:t}),this._createConnectionAndInvokeNextCallback()},_createConnectionAndInvokeNextCallback:function(){var t=this,n=this._callbackQueue.first();if(e.isNull(n))return;if(this._peerAgent.isWaitingOpeningConnection())return;if(this._connectionPool.has(n.peerId)){var r=this._connectionPool.get(n.peerId);if(r.isAvailable()){this._invokeNextCallback(r.getPeerId(),r);return}this.removeConnection(r.getPeerId())}this._peerAgent.connect(n.peerId)},_invokeNextCallback:function(t,n,r){var i=this;e.defer(function(){i._createConnectionAndInvokeNextCallback()});var s=this._callbackQueue.dequeue();if(e.isNull(s)){console.log("Unknown situation.");return}if(s.peerId!==t){s.callback(null,new Error("Unknown situation."));return}s.callback(n,r)},removeConnection:function(t){var n=this._connectionPool.get(t);if(e.isNull(n))return;n.destroy(),this._connectionPool.remove(t)},destroy:function(){this._peerAgent.destroy()},getPeerId:function(){return this._peerAgent.getPeerId()},listAllPeers:function(e){this._peerAgent.listAllPeers(e)}},i}),n("RequestHandler",["underscore","ID","Response","Entry","Utils"],function(e,t,n,r,i){var s=function(e,t){this._localNode=e,this._nodeFactory=t};return s.prototype={handle:function(n,s,o){var u=this;switch(s.method){case"FIND_SUCCESSOR":if(!i.isNonemptyString(s.params.key)){this._sendFailureResponse("Invalid params.",s,o);return}var a=t.fromHexString(s.params.key);this._localNode.findSuccessor(a,function(e,t){if(t){console.log(t),u._sendFailureResponse(h.message,s,o);return}u._sendSuccessResponse({successorNodeInfo:e.toNodeInfo()},s,o)});break;case"NOTIFY_AND_COPY":var f=s.params.potentialPredecessorNodeInfo;this._nodeFactory.create(f,function(t,n){if(n){console.log(n),this._sendFailureResponse(h.message,s,o);return}u._localNode.notifyAndCopyEntries(t,function(t,n){if(e.isNull(t)||e.isNull(n)){u._sendFailureResponse("Unknown error.",s,o);return}u._sendSuccessResponse({referencesNodeInfo:e.invoke(t,"toNodeInfo"),entries:e.invoke(n,"toJson")},s,o)})});break;case"NOTIFY":var f=s.params.potentialPredecessorNodeInfo;this._nodeFactory.create(f,function(t,n){if(n){console.log(n),u._sendFailureResponse(h.message,s,o);return}u._localNode.notify(t,function(t){if(e.isNull(t)){u._sendFailureResponse("Unknown error.",s,o);return}u._sendSuccessResponse({referencesNodeInfo:e.invoke(t,"toNodeInfo")},s,o)})});break;case"PING":u._sendSuccessResponse({},s,o);break;case"INSERT_REPLICAS":if(!e.isArray(s.params.replicas))return;var l=e.chain(s.params.replicas).map(function(e){try{return r.fromJson(e)}catch(t){return null}}).reject(function(t){return e.isNull(t)}).value();u._localNode.insertReplicas(l);break;case"REMOVE_REPLICAS":var c;try{c=t.fromHexString(s.params.sendingNodeId)}catch(h){return}if(!e.isArray(s.params.replicas))return;var l=e.chain(s.params.replicas).map(function(e){try{return r.fromJson(e)}catch(t){return null}}).reject(function(t){return e.isNull(t)}).value();u._localNode.removeReplicas(c,l);break;case"INSERT_ENTRY":var p;try{p=r.fromJson(s.params.entry)}catch(h){u._sendFailureResponse(h.message,s,o);return}u._localNode.insertEntry(p,function(e){e?u._sendSuccessResponse({},s,o):u._sendFailureResponse("Unknown error.",s,o)});break;case"RETRIEVE_ENTRIES":var d;try{d=t.fromHexString(s.params.id)}catch(h){u._sendFailureResponse(h.message,s,o);return}u._localNode.retrieveEntries(d,function(t){e.isNull(t)?u._sendFailureResponse("Unknown error.",s,o):u._sendSuccessResponse({entries:e.invoke(t,"toJson")},s,o)});break;case"REMOVE_ENTRY":var p;try{p=r.fromJson(s.params.entry)}catch(h){u._sendFailureResponse(h.message,s,o);return}u._localNode.removeEntry(p,function(e){e?u._sendSuccessResponse({},s,o):u._sendFailureResponse("Unknown error.",s,o)});break;case"UPPER_LAYER_MESSAGE":if(!e.has(s.params,"message"))return;u._localNode.onMessageReceived(n,s.params.message);break;case"SHUTDOWN":break;case"LEAVES_NETWORK":var v=s.params.predecessorNodeInfo;this._nodeFactory.create(v,function(e,t){if(t){console.log(t);return}u._localNode.leavesNetwork(e)});break;default:this._sendFailureResponse("Unknown request method type.",s,o)}},_sendSuccessResponse:function(e,t,r){var i=this,s;try{s=n.create("SUCCESS",e,t)}catch(o){this._sendFailureResponse(o.message,t,r);return}r(s)},_sendFailureResponse:function(e,t,r){var i;try{i=n.create("FAILED",{message:e},t)}catch(s){return}r(i)}},s}),n("NodeFactory",["underscore","Node","ConnectionFactory","RequestHandler","ID","Utils"],function(e,t,n,r,i,s){var o=function(t,n){var i=this;if(e.isNull(t))throw new Error("Invalid arguments.");this._localNode=t,this._config=n,this._connectionFactory=null,this._requestHandler=new r(t,this),this._callbacks={}};return o.create=function(t,r,i){e.isNull(t)&&i(null,null);var s=new o(t,r);n.create(r,s,function(e,t){if(t){i(null,null,t);return}s._connectionFactory=e,i(e.getPeerId(),s)})},o.prototype={create:function(e,n){var r=this;if(!t.isValidNodeInfo(e)){n(null,new Error("Invalid node info."));return}if(this._localNode.nodeId.equals(i.create(e.peerId))){n(this._localNode);return}var s=new t(e,this,this._connectionFactory,this._requestHandler,this._config);n(s)},createAll:function(t,n){var r=this;if(e.isEmpty(t)){n([]);return}this.create(e.first(t),function(i,s){r.createAll(e.rest(t),function(e){s?(console.log(s),n(e)):n([i].concat(e))})})},onRequestReceived:function(e,t){this.create({peerId:e},function(e,n){if(n){console.log(n);return}e.onRequestReceived(t)})},onResponseReceived:function(e,t){this.create({peerId:e},function(e,n){if(n){console.log(n);return}e.onResponseReceived(t)})},registerCallback:function(e,t){this._callbacks[e]=t},deregisterCallback:function(t){if(!e.has(this._callbacks,t))return null;var n=this._callbacks[t];return delete this._callbacks[t],n},destroy:function(){this._connectionFactory.destroy()},listAllPeers:function(e){this._connectionFactory.listAllPeers(e)}},o}),n("EntryList",["underscore","ID","Utils"],function(e,t,n){var r=function(){this._entries={}};return r.prototype={addAll:function(t){var n=this;if(e.isNull(t))throw new Error("Invalid argument.");e.each(t,function(e){n.add(e)})},add:function(t){if(e.isNull(t))throw new Error("Invalid argument.");e.has(this._entries,t.id.toHexString())?this._entries[t.id.toHexString()].put(t):this._entries[t.id.toHexString()]=new n.Set([t],function(e,t){return e.equals(t)}),n.debug("An entry added (key:",t.id.toHexString(),")")},remove:function(t){if(e.isNull(t))throw new Error("Invalid argument.");if(!e.has(this._entries,t.id.toHexString()))return;this._entries[t.id.toHexString()].remove(t),this._entries[t.id.toHexString()].size()===0&&delete this._entries[t.id.toHexString()],n.debug("An entry removed (key:",t.id.toHexString(),")")},getEntries:function(t){if(e.isNull(t))throw new Error("Invalid argument.");return e.isUndefined(t)?this._entries:e.has(this._entries,t.toHexString())?this._entries[t.toHexString()].items():[]},getEntriesInInterval:function(n,r){if(e.isNull(n)||e.isNull(r))throw new Error("Invalid argument.");var i=[];return e.each(this._entries,function(e,s){t.fromHexString(s).isInInterval(n,r)&&(i=i.concat(e.items()))}),i=i.concat(this.getEntries(r)),i},removeAll:function(t){var n=this;if(e.isNull(t))throw new Error("Invalid argument.");e.each(t,function(e){n.remove(e)})},getNumberOfStoredEntries:function(){return e.size(this._entries)},getStatus:function(){return e.chain(this._entries).map(function(t,n){return[n,e.map(t,function(e){return e.value})]}).object().value()},toString:function(){var n=this;return"[Entries]\n"+e.chain(this._entries).keys().map(function(e){return t.fromHexString(e)}).sort(function(e,t){return e.compareTo(t)}).map(function(t){return"["+t.toHexString()+"]\n"+e.map(n.getEntries(t),function(e){return JSON.stringify(e.value)}).join("\n")+"\n"}).value().join("\n")+"\n"}},r}),n("FingerTable",["underscore"],function(e){var t=function(t,n){if(e.isNull(t)||e.isNull(n))throw new Error("Invalid arguments.");this._localId=t,this._references=n,this._remoteNodes={}};return t.prototype={_setEntry:function(t,n){if(!e.isNumber(t)||e.isNull(n))throw new Error("Invalid arguments.");if(t<0||t>=this._localId.getLength())throw new Error("Invalid index.");this._remoteNodes[t]=n},_getEntry:function(t){if(!e.isNumber(t))throw new Error("Invalid argument.");if(t<0||t>=this._localId.getLength())throw new Error("Invalid index.");return e.has(this._remoteNodes,t)?this._remoteNodes[t]:null},_unsetEntry:function(t){if(!e.isNumber(t))throw new Error("Invalid argument.");if(t<0||t>=this._localId.getLength())throw new Error("Invalid index.");var n=this._getEntry(t);delete this._remoteNodes[t],e.isNull(n)||this._references.disconnectIfUnreferenced(n)},addReference:function(t){if(e.isNull(t))throw new Error("Invalid argument.");for(var n=0;n<this._localId.getLength();n++){var r=this._localId.addPowerOfTwo(n);if(!r.isInInterval(this._localId,t.nodeId))break;if(e.isNull(this._getEntry(n)))this._setEntry(n,t);else if(t.nodeId.isInInterval(this._localId,this._getEntry(n).nodeId)){var i=this._getEntry(n);this._setEntry(n,t),this._references.disconnectIfUnreferenced(i)}}},getClosestPrecedingNode:function(t){if(e.isNull(t))throw new Error("Invalid argument.");var n=e.chain(this._remoteNodes).keys().map(function(e){return parseInt(e)}).sortBy().value();for(var r=e.size(n)-1;r>=0;r--){var i=n[r];if(!e.isNull(this._getEntry(i))&&this._getEntry(i).nodeId.isInInterval(this._localId,t))return this._getEntry(i)}return null},removeReference:function(t){var n=this;if(e.isNull(t))throw new Error("Invalid argument.");var r=null,i=e.chain(this._remoteNodes).keys().map(function(e){return parseInt(e)}).sortBy().value();for(var s=e.size(i)-1;s>=0;s--){var o=i[s],u=this._getEntry(o);if(t.equals(u))break;e.isNull(u)||(r=u)}e.each(i,function(i){t.equals(n._getEntry(i))&&(e.isNull(r)?n._unsetEntry(i):n._setEntry(i,r))}),e.chain(this._references.getSuccessors()).reject(function(e){return e.equals(t)}).each(function(e){n.addReference(e)})},getFirstFingerTableEntries:function(t){var n=[],r=e.chain(this._remoteNodes).keys().map(function(e){return parseInt(e)}).sortBy().value();for(var i=0;i<e.size(r);i++){var s=r[i];e.isNull(this._getEntry(s))||(e.isEmpty(n)||!e.last(n).equals(this._getEntry(s)))&&n.push(this._getEntry(s));if(e.size(n)>=t)break}return n},containsReference:function(t){if(e.isNull(t))throw new Error("Invalid argument.");return e.some(this._remoteNodes,function(e){return e.equals(t)})},getStatus:function(){var t=this;return e(this._localId.getLength()).times(function(n){return e.isNull(t._getEntry(n))?null:t._getEntry(n).toNodeInfo()})},toString:function(){var t=this;return"[FingerTable]\n"+e.chain(this._remoteNodes).keys().map(function(e){return parseInt(e)}).sortBy().map(function(n,r,i){if(r===0||r>0&&!t._getEntry(i[r]).equals(t._getEntry(i[r-1])))return"["+n+"] "+t._getEntry(n).toString();if(r===e.size(i)-1||r<e.size(i)-1&&!t._getEntry(i[r]).equals(t._getEntry(i[r+1])))return"["+n+"]";if(r>1&&t._getEntry(i[r]).equals(t._getEntry(i[r-1]))&&!t._getEntry(i[r]).equals(t._getEntry(i[r-2]))||r===1&&t._getEntry(i[r]).equals(t._getEntry(i[r-1])))return"...";if(r>1&&t._getEntry(i[r]).equals(t._getEntry(i[r-1]))&&t._getEntry(i[r]).equals(t._getEntry(i[r-2])))return"";throw new Error("Unknown situation.")}).reject(function(e){return e===""}).value().join("\n")+"\n"}},t}),n("SuccessorList",["underscore","Utils"],function(e,t){var n=function(n,r,i,s){if(e.isNull(n)||e.isNull(r)||e.isNull(i))throw new Error("Invalid argument.");t.isPositiveNumber(s.numberOfEntriesInSuccessorList)||(s.numberOfEntriesInSuccessorList=3),this._localId=n,this._capacity=s.numberOfEntriesInSuccessorList,this._entries=r,this._references=i,this._successors=[]};return n.prototype={addSuccessor:function(n){if(e.isNull(n))throw new Error("Invalid argument.");if(this.containsReference(n))return;if(e.size(this._successors)>=this._capacity&&n.nodeId.isInInterval(e.last(this._successors).nodeId,this._localId))return;var r=!1;for(var i=0;i<e.size(this._successors);i++)if(n.nodeId.isInInterval(this._localId,this._successors[i].nodeId)){t.insert(this._successors,i,n),r=!0;break}r||(this._successors.push(n),r=!0);var s,o=this._references.getPredecessor();if(!e.isNull(o))s=o.nodeId;else{var u=this._references.getClosestPrecedingNode(this._localId);e.isNull(u)?s=this._localId:s=u.nodeId}var a=this._localId,f=this._entries.getEntriesInInterval(s,a);n.insertReplicas(f);if(e.size(this._successors)>this._capacity){var l=this._successors.pop();l.removeReplicas(this._localId,[]),this._references.disconnectIfUnreferenced(l)}},getDirectSuccessor:function(){return e.isEmpty(this._successors)?null:this._successors[0]},getClosestPrecedingNode:function(t){if(e.isNull(t))throw new Error("Invalid argument.");for(var n=e.size(this._successors)-1;n>=0;n--)if(this._successors[n].nodeId.isInInterval(this._localId,t))return this._successors[n];return null},getReferences:function(){return this._successors},removeReference:function(t){var n=this;if(e.isNull(t))throw new Error("Invalid argument.");this._successors=e.reject(this._successors,function(e){return e.equals(t)});var r=this._references.getFirstFingerTableEntries(this._capacity);r=e.reject(r,function(e){return e.equals(t)}),e.each(r,function(e){n.addSuccessor(e)})},getSize:function(){return e.size(this._successors)},getCapacity:function(){return this._capacity},containsReference:function(t){if(e.isNull(t))throw new Error("Invalid argument.");return!e.isUndefined(e.find(this._successors,function(e){return e.equals(t)}))},getStatus:function(){return e.invoke(this._successors,"toNodeInfo")},toString:function(){return"[Successors]\n"+e.map(this._successors,function(e,t){return"["+t+"] "+e.toString()}).join("\n")+"\n"}},n}),n("ReferenceList",["underscore","FingerTable","SuccessorList"],function(e,t,n){var r=function(r,i,s){if(e.isNull(r)||e.isNull(i))throw new Error("Invalid arguments.");this._localId=r,this._fingerTable=new t(r,this),this._successors=new n(r,i,this,s),this._predecessor=null,this._entries=i};return r.prototype={addReference:function(t){if(e.isNull(t))throw new Error("Invalid argument.");if(t.nodeId.equals(this._localId))return;this._fingerTable.addReference(t),this._successors.addSuccessor(t)},removeReference:function(t){if(e.isNull(t))throw new Error("Invalid argument.");this._fingerTable.removeReference(t),this._successors.removeReference(t),t.equals(this.getPredecessor())&&(this._predecessor=null),this.disconnectIfUnreferenced(t)},getSuccessor:function(){return this._successors.getDirectSuccessor()},getSuccessors:function(){return this._successors.getReferences()},getClosestPrecedingNode:function(t){if(e.isNull(t))throw new Error("Invalid argument.");var n=[],r=this._fingerTable.getClosestPrecedingNode(t);e.isNull(r)||n.push(r);var i=this._successors.getClosestPrecedingNode(t);e.isNull(i)||n.push(i),!e.isNull(this._predecessor)&&t.isInInterval(this._predecessor.nodeId,this._localId)&&n.push(this._predecessor),n.sort(function(e,t){return e.nodeId.compareTo(t.nodeId)});var s=e.chain(n).map(function(e){return e.nodeId}).sortedIndex(function(e){return e.equals(t)}).value(),o=(e.size(n)+(s-1))%e.size(n),u=n[o];if(e.isNull(u))throw new Error("Closest node must not be null.");return u},getPredecessor:function(){return this._predecessor},addReferenceAsPredecessor:function(t){if(e.isNull(t))throw new Error("Invalid argument.");if(t.nodeId.equals(this._localId))return;(e.isNull(this._predecessor)||t.nodeId.isInInterval(this._predecessor.nodeId,this._localId))&&this.setPredecessor(t),this.addReference(t)},setPredecessor:function(t){if(e.isNull(t))throw new Error("Invalid argument.");if(t.nodeId.equals(this._localId))return;if(t.equals(this._predecessor))return;var n=this._predecessor;this._predecessor=t;if(!e.isNull(n)){this.disconnectIfUnreferenced(n);var r=this._successors.getSize();if(this._successors.getCapacity()===r){var i=e.last(this._successors.getReferences());i.removeReplicas(this._predecessor.nodeId,[])}}else{var s=this._entries.getEntriesInInterval(this._predecessor.nodeId,this._localId),o=this._successors.getReferences();e.each(o,function(e){e.insertReplicas(s)})}},disconnectIfUnreferenced:function(t){if(e.isNull(t))throw new Error("Invalid argument.");this.containsReference(t)||t.disconnect()},getFirstFingerTableEntries:function(e){return this._fingerTable.getFirstFingerTableEntries(e)},containsReference:function(t){if(e.isNull(t))throw new Error("Invalid argurment.");return this._fingerTable.containsReference(t)||this._successors.containsReference(t)||t.equals(this._predecessor)},getStatuses:function(){return{successors:this._successors.getStatus(),fingerTable:this._fingerTable.getStatus(),predecessor:e.isNull(this.getPredecessor())?null:this.getPredecessor().toNodeInfo()}},toString:function(){return[this._successors.toString(),"[Predecessor]\n"+(e.isNull(this.getPredecessor())?"":this.getPredecessor().toString())+"\n",this._fingerTable.toString()].join("\n")+"\n"}},r}),n("StabilizeTask",["underscore","Utils"],function(e,t){var n=function(e,t,n){this._localNode=e,this._references=t,this._entries=n,this._timer=null};return n.create=function(e,r,i,s){t.isZeroOrPositiveNumber(s.stabilizeTaskInterval)||(s.stabilizeTaskInterval=3e4);var o=new n(e,r,i),u=setInterval(function(){o.run()},s.stabilizeTaskInterval);return o._timer=u,o},n.prototype={run:function(){var n=this,r=this._references.getSuccessors();if(e.isEmpty(r))return;var i=e.first(r);i.notify(this._localNode,function(s,o){if(o){console.log(o),n._references.removeReference(i);return}var u=function(t){e.chain(r).reject(function(r){return r.equals(i)||!e.isNull(n._references.getPredecessor())&&r.equals(n._references.getPredecessor())||e.some(t,function(e){return e.equals(r)})}).each(function(e){n._references.removeReference(e)}),e.each(t,function(e){n._references.addReference(e)});var s=n._references.getSuccessor();s.equals(i)||s.ping(function(e,t){t&&(console.log(t),n._references.removeReference(s))})};e.size(s)>0&&!e.isNull(s[0])&&(n._localNode.equals(s[0])||i.notifyAndCopyEntries(n._localNode,function(r,i,s){if(s){console.log(s);return}n._entries.addAll(i),u(r),t.debug("[StabilizeTask] successors:",e.map(n._references.getSuccessors(),function(e){return e.getPeerId()}).toString())})),u(s),t.debug("[StabilizeTask] successors:",e.map(n._references.getSuccessors(),function(e){return e.getPeerId()}).toString())})},shutdown:function(){e.isNull(this._timer)||clearInterval(this._timer)}},n}),n("FixFingerTask",["underscore","Utils"],function(e,t){var n=function(e,t){this._localNode=e,this._references=t,this._timer=null};return n.create=function(e,r,i){t.isZeroOrPositiveNumber(i.fixFingerTaskInterval)||(i.fixFingerTaskInterval=3e4);var s=new n(e,r),o=setInterval(function(){s.run()},i.fixFingerTaskInterval);return s._timer=o,s},n.prototype={run:function(){var n=this,r=e.random(this._localNode.nodeId.getLength()-1),i=this._localNode.nodeId.addPowerOfTwo(r);this._localNode.findSuccessor(i,function(i,s){if(s){console.log(s);return}!e.isNull(i)&&!n._references.containsReference(i)&&n._references.addReference(i),t.debug("[FixFingerTask] finger:",r,", successor:",i.getPeerId())})},shutdown:function(){e.isNull(this._timer)||clearInterval(this._timer)}},n}),n("CheckPredecessorTask",["underscore","Utils"],function(e,t){var n=function(e){this._references=e,this._timer=null};return n.create=function(e,r){t.isZeroOrPositiveNumber(r.checkPredecessorTaskInterval)||(r.checkPredecessorTaskInterval=3e4);var i=new n(e),s=setInterval(function(){i.run()},r.checkPredecessorTaskInterval);return i._timer=s,i},n.prototype={run:function(){var n=this,r=this._references.getPredecessor();if(e.isNull(r))return;r.ping(function(e,i){if(i){console.log(i),n._references.removeReference(r);return}r=n._references.getPredecessor(),t.debug("[CheckPredecessorTask] predecessor:",r?r.getPeerId():null)})},shutdown:function(){e.isNull(this._timer)||clearInterval(this._timer)}},n}),n("LocalNode",["underscore","NodeFactory","EntryList","Entry","ReferenceList","ID","StabilizeTask","FixFingerTask","CheckPredecessorTask","Utils"],function(e,t,n,r,i,s,o,u,a,f){var l=function(e,t){this._chord=e,this._config=t,this.nodeId=null,this._peerId=null,this._nodeFactory=null,this._tasks={},this._entries=null,this._references=null};return l.create=function(e,n,r){var i=new l(e,n);t.create(i,n,function(e,t,n){if(n){r(null,n);return}i.setup(e,t),r(i)})},l.prototype={setup:function(e,t){this._peerId=e,this.nodeId=s.create(e),this._nodeFactory=t,this._entries=new n,this._references=new i(this.nodeId,this._entries,this._config)},_createTasks:function(){this._tasks={stabilizeTask:o.create(this,this._references,this._entries,this._config),fixFingerTask:u.create(this,this._references,this._config),checkPredecessorTask:a.create(this._references,this._config)},f.debug("Created tasks.")},_shutdownTasks:function(){e.invoke(this._tasks,"shutdown"),f.debug("Shutdown tasks.")},create:function(e){this._createTasks(),f.debug("Created network (peer ID:",this._peerId,")."),e(this._peerId)},join:function(t,n){var r=this;f.debug("Trying to join network."),this._nodeFactory.create({peerId:t},function(t,i){if(i){n(null,i);return}r._references.addReference(t),t.findSuccessor(r.nodeId,function(i,s){if(s){f.debug("[join] Failed to find successor:",s),r._references.removeReference(t),n(null,s);return}f.debug("[join] Found successor:",i.getPeerId()),r._references.addReference(i);var o=function(t,n){f.debug("[join] Trying to notify and copy entries (remote peer ID:",t.getPeerId(),")."),t.notifyAndCopyEntries(r,function(s,u,a){if(a){f.debug("[join] Failed to notify and copy entries (remote peer ID:",t.getPeerId(),")."),n(null,null,a);return}if(e.size(s)===1){f.debug("[join]",i.getPeerId(),"is successor and also predecessor."),r._references.addReferenceAsPredecessor(i),n(s,u);return}if(r.nodeId.isInInterval(s[0].nodeId,i.nodeId)){f.debug("[join]",s[0].getPeerId(),"is predecessor."),r._references.addReferenceAsPredecessor(s[0]),n(s,u);return}f.debug("[join] Failed to find predecessor. Retry to notify and copy entries."),r._references.addReference(s[0]),o(s[0],n)})};o(i,function(t,i,s){if(s){console.log(s),r._createTasks(),n(r._peerId);return}e.each(t,function(t){!e.isNull(t)&&!t.equals(r)&&!r._references.containsReference(t)&&r._references.addReference(t)}),r._entries.addAll(i),e.defer(function(){r._chord.onentriesinserted(e.invoke(i,"toJson"))}),r._createTasks(),f.debug("Joining network succeeded."),n(r._peerId)})})})},leave:function(t){var n=this;this._shutdownTasks();var r=this._references.getSuccessor();!e.isNull(r)&&!e.isNull(this._references.getPredecessor())&&r.leavesNetwork(this._references.getPredecessor()),this._nodeFactory.destroy(),f.debug("Left network."),t()},insert:function(e,t,n){var i=s.create(e),o;try{o=new r(i,t)}catch(u){n(u);return}this.findSuccessor(i,function(e,t){if(t){n(t);return}e.insertEntry(o,n)})},retrieve:function(t,n){var r=s.create(t);this.findSuccessor(r,function(t,i){if(i){n(null,i);return}t.retrieveEntries(r,function(t,r){if(r){n(null,r);return}n(e.map(t,function(e){return e.value}))})})},remove:function(e,t,n){var i=s.create(e),o;try{o=new r(i,t)}catch(u){n(u);return}this.findSuccessor(i,function(e,t){if(t){n(t);return}e.removeEntry(o,n)})},findSuccessor:function(t,n){var r=this;e.isNull(t)&&n(null,new Error("Invalid argument."));var i=this._references.getSuccessor();if(e.isNull(i)){n(this);return}if(t.isInInterval(this.nodeId,i.nodeId)||t.equals(i.nodeId)){n(i);return}var s=this._references.getClosestPrecedingNode(t);s.findSuccessor(t,function(e,i){if(i){console.log(i),r._references.removeReference(s),r.findSuccessor(t,n);return}n(e)})},notifyAndCopyEntries:function(e,t){var n=this,r=this.notify(e,function(r){var i=n._entries.getEntriesInInterval(n.nodeId,e.nodeId);t(r,i)})},notify:function(t,n){var r=[];e.isNull(this._references.getPredecessor())?r.push(t):r.push(this._references.getPredecessor()),r=r.concat(this._references.getSuccessors()),this._references.addReferenceAsPredecessor(t),n(r)},leavesNetwork:function(e){this._references.removeReference(this._references.getPredecessor()),this._references.addReferenceAsPredecessor(e)},insertReplicas:function(t){var n=this;this._entries.addAll(t),e.defer(function(){n._chord.onentriesinserted(e.invoke(t,"toJson"))})},removeReplicas:function(t,n){var r=this;if(e.size(n)!==0){this._entries.removeAll(n),e.defer(function(){r._chord.onentriesremoved(e.invoke(n,"toJson"))});return}var i=this._entries.getEntriesInInterval(this.nodeId,t);this._entries.removeAll(i),e.defer(function(){r._chord.onentriesremoved(e.invoke(i,"toJson"))})},insertEntry:function(t,n){var r=this;if(!e.isNull(this._references.getPredecessor())&&!t.id.isInInterval(this._references.getPredecessor().nodeId,this.nodeId)){this._references.getPredecessor().insertEntry(t,n);return}this._entries.add(t),e.defer(function(){r._chord.onentriesinserted([t.toJson()])}),e.each(this._references.getSuccessors(),function(e){e.insertReplicas([t])}),n(!0)},retrieveEntries:function(t,n){if(!e.isNull(this._references.getPredecessor())&&!t.isInInterval(this._references.getPredecessor().nodeId,this.nodeId)){this._references.getPredecessor().retrieveEntries(t,n);return}n(this._entries.getEntries(t))},removeEntry:function(t,n){var r=this;if(!e.isNull(this._references.getPredecessor())&&!t.id.isInInterval(this._references.getPredecessor().nodeId,this.nodeId)){this._references.getPredecessor().removeEntry(t,n);return}this._entries.remove(t),e.defer(function(){r._chord.onentriesremoved([t.toJson()])}),e.each(this._references.getSuccessors(),function(e){e.removeReplicas(r.nodeId,[t])}),n(!0)},sendMessage:function(t,n){if(e.isNull(t)){var r=f.Set(this._references.getFirstFingerTableEntries(),function(e,t){return e.equals(t)});e.each(this._references.getSuccessors(),function(e){r.put(e)}),e.each(r.items(),function(e){e.sendMessage(n)});return}this._nodeFactory.create({peerId:t},function(e){e.sendMessage(n)})},onMessageReceived:function(e,t){this._chord.onMessageReceived(e,t)},listAllPeers:function(e){this._nodeFactory.listAllPeers(e)},getStatuses:function(){var e=this._references.getStatuses();return e.entries=this._entries.getStatus(),e},getPeerId:function(){return this._peerId},toNodeInfo:function(){return{nodeId:this.nodeId.toHexString(),peerId:this._peerId}},equals:function(t){return e.isNull(t)?!1:this.nodeId.equals(t.nodeId)},toString:function(){return this.nodeId.toHexString()+" ("+this._peerId+")"},toDisplayString:function(){return[this._references.toString(),this._entries.toString()].join("\n")+"\n"}},l}),n("Chord",["underscore","LocalNode","Utils"],function(e,t,n){var r=function(t,r){if(!e.isObject(t))throw new Error("Invalid argument.");n.enableDebugLog(t.debug),this._config=t,this._localNode=null,this.onentriesinserted=function(e){},this.onentriesremoved=function(e){},this._onMessageReceivedCallback=r};return r.prototype={create:function(e){var n=this;if(this._localNode)throw new Error("Local node is already created.");e||(e=function(){}),t.create(this,this._config,function(t,r){if(r){e(null,r);return}n._localNode=t,n._localNode.create(function(t,r){r&&(n.leave(),n._localNode=null),e(t,r)})})},join:function(e,r){var i=this;if(!n.isNonemptyString(e))throw new Error("Invalid argument.");if(this._localNode)throw new Error("Local node is already created.");r||(r=function(){}),t.create(this,this._config,function(t,n){if(n){r(null,n);return}i._localNode=t,i._localNode.join(e,function(e,t){t&&(i.leave(),i._localNode=null),r(e,t)})})},leave:function(){var e=this;if(!this._localNode)return;this._localNode.leave(function(){e._localNode=null})},insert:function(t,r,i){i||(i=function(){});if(!this._localNode){i(new Error("Create or join network at first."));return}if(!n.isNonemptyString(t)||e.isUndefined(r)){i(new Error("Invalid arguments."));return}this._localNode.insert(t,r,i)},retrieve:function(e,t){t||(t=function(){});if(!this._localNode){t(new Error("Create or join network at first."));return}if(!n.isNonemptyString(e)){t(new Error("Invalid argument."));return}this._localNode.retrieve(e,t)},remove:function(t,r,i){i||(i=function(){});if(!this._localNode){i(new Error("Create or join network at first."));return}if(!n.isNonemptyString(t)||e.isUndefined(r)){i(new Error("Invalid arguments."));return}this._localNode.remove(t,r,i)},sendMessage:function(e,t){if(!this._localNode)throw new Error("Create or join network at first.");this._localNode.sendMessage(e,t)},onMessageReceived:function(e,t){this._onMessageReceivedCallback(e,t)},listAllPeers:function(e){if(!this._localNode){e(null,new Error("Create or join network at first."));return}this._localNode.listAllPeers(e)},getStatuses:function(){if(!this._localNode)throw new Error("Create or join network at first.");return this._localNode.getStatuses()},getPeerId:function(){if(!this._localNode)throw new Error("Create or join network at first.");return this._localNode.getPeerId()},getNodeId:function(){if(!this._localNode)throw new Error("Create or join network at first.");return this._localNode.nodeId.toHexString()},toString:function(){return this._localNode?this._localNode.toDisplayString():""}},r}),t("Chord")});